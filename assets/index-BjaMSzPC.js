import{createClient as O}from"https://esm.sh/@supabase/supabase-js@2.45.4";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=i(n);fetch(n.href,o)}})();const A="https://vsrdlcafkrubktirwczq.supabase.co",k="sb_publishable_NgIiYGeuJFv4x9N9sRrf3A_lRnWdTW9",d=O(A,k,{auth:{persistSession:!0,autoRefreshToken:!0}}),a=e=>document.getElementById(e);let v=null;const g="julie@heartlandsign.com,teja@heartlandsign.com",y=15;function w(){return new Date().toISOString().split("T")[0]}function S(e){return e?new Date(e+"T00:00:00").toLocaleDateString():""}function T(e){const t=new Date,i=new Date(e+"T00:00:00");return Math.ceil((i-t)/(1e3*60*60*24))}function p(e,t=0){const i=Number(e);return Number.isFinite(i)?i:t}function Y(e){return e?e.split(",").map(t=>t.trim()).filter(Boolean).join(","):g}async function M(){const{data:{session:e}}=await d.auth.getSession(),t=!!e;return a("btnLogout").style.display=t?"inline-block":"none",a("btnSignUp").style.display=t?"none":"inline-block",a("btnSignIn").style.display=t?"none":"inline-block",a("authEmail").style.display=t?"none":"inline-block",a("authPassword").style.display=t?"none":"inline-block",a("authStatus").textContent=t?`✅ Logged in as ${e.user.email}`:"❌ Not logged in",a("vehicleForm").querySelectorAll("input, button").forEach(i=>i.disabled=!t),t||(a("vehicles").innerHTML='<div class="muted">Login to view vehicles.</div>',a("vehicleDetails").style.display="none",a("selectedVehicle").textContent="Login to manage vehicles.",a("services").innerHTML="",a("reminders").innerHTML="",v=null),t}async function C(){const e=a("authEmail").value.trim(),t=a("authPassword").value;if(!e||!t)return alert("Enter email and password.");const{error:i}=await d.auth.signUp({email:e,password:t});if(i)return alert(i.message);alert("Account created. Now click Sign In.")}async function q(){const e=a("authEmail").value.trim(),t=a("authPassword").value;if(!e||!t)return alert("Enter email and password.");const{error:i}=await d.auth.signInWithPassword({email:e,password:t});if(i)return alert(i.message);await f()}async function H(){await d.auth.signOut(),await f()}async function E(){const{data:{session:e}}=await d.auth.getSession();if(!e){a("dashboard").innerHTML="<div class='muted'>Login to see reminders.</div>";return}const{data:t,error:i}=await d.from("reminders").select("id, name, reminder_type, due_date, warn_days, is_active, vehicle_id").eq("reminder_type","date").eq("is_active",!0);if(i){a("dashboard").innerHTML=`<div class="muted">${i.message}</div>`;return}const s=Array.from(new Set((t||[]).map(c=>c.vehicle_id).filter(Boolean))),{data:n}=await d.from("vehicles").select("id, name, type").in("id",s),o=new Map((n||[]).map(c=>[c.id,c])),r=[],l=[];for(const c of t||[]){if(!c.due_date)continue;const m=T(c.due_date),u=Number.isFinite(c.warn_days)?c.warn_days:y,h=o.get(c.vehicle_id),L=h?`${h.name} (${h.type})`:"Vehicle";m<=0?r.push({...c,d:m,label:L}):m<=u&&l.push({...c,d:m,label:L})}r.sort((c,m)=>(c.due_date||"").localeCompare(m.due_date||"")),l.sort((c,m)=>(c.due_date||"").localeCompare(m.due_date||""));const _=(c,m)=>c.length===0?`<div class="muted">${m}: none</div>`:`
      <div style="margin:8px 0;"><b>${m}</b></div>
      <div class="list">
        ${c.map(u=>`
          <div class="item">
            <div>
              <div><b>${u.label}</b> — ${u.name}</div>
              <div class="muted">Due: ${S(u.due_date)} (${u.d} day(s))</div>
            </div>
          </div>
        `).join("")}
      </div>
    `;a("dashboard").innerHTML=_(r,"DUE")+'<div style="height:10px;"></div>'+_(l,`SOON (<= ${y} days unless reminder has warn_days set)`)}async function U(){const{data:e,error:t}=await d.from("vehicles").select("*").order("created_at",{ascending:!0});if(t){a("vehicles").innerHTML=`<div class="muted">${t.message}</div>`;return}const i=document.createElement("div");i.className="list",(e||[]).forEach(s=>{const n=document.createElement("div");n.className="item",n.innerHTML=`
      <div>
        <div><b>${s.name}</b> <span class="badge">${s.type}</span></div>
        <div class="muted">Miles: ${s.current_odometer??0} • Hours: ${s.current_engine_hours??0}</div>
      </div>
      <div><button class="secondary">Open</button></div>
    `,n.querySelector("button").onclick=()=>D(s.id),i.appendChild(n)}),a("vehicles").innerHTML="",a("vehicles").appendChild(i)}async function V(e,t){const i=prompt("Service date (YYYY-MM-DD):",w());if(!i)return;const s=prompt("Category (Oil/Brakes/Tires/DOT/etc):","Oil");if(!s)return;const n=prompt("What was done / what changed?","");if(!n)return;const o={vehicle_id:e,service_date:i,category:s,description:n,odometer:t.current_odometer??null,engine_hours:t.current_engine_hours??null},{error:r}=await d.from("services").insert(o);if(r)return alert(r.message);await $(e)}async function F(e){const t=prompt("Service date (YYYY-MM-DD):",e.service_date||w());if(!t)return;const i=prompt("Category:",e.category||"Oil");if(!i)return;const s=prompt("Description:",e.description||"");if(!s)return;const n=prompt("Miles at service (optional):",e.odometer??""),o=prompt("Engine hours (optional):",e.engine_hours??""),r={service_date:t,category:i,description:s,odometer:n===""?null:p(n,null),engine_hours:o===""?null:p(o,null)},{error:l}=await d.from("services").update(r).eq("id",e.id);if(l)return alert(l.message);await $(e.vehicle_id)}async function R(e,t){if(!confirm("Delete this service record?"))return;const{error:i}=await d.from("services").delete().eq("id",e);if(i)return alert(i.message);await $(t)}async function $(e){const{data:t,error:i}=await d.from("services").select("*").eq("vehicle_id",e).order("service_date",{ascending:!1});if(i){a("services").innerHTML=`<div class="muted">${i.message}</div>`;return}const s=document.createElement("div");s.className="list",(t||[]).forEach(n=>{const o=document.createElement("div");o.className="item",o.innerHTML=`
      <div>
        <div><b>${n.category}</b> <span class="badge">${S(n.service_date)}</span></div>
        <div>${n.description}</div>
        <div class="muted">Miles: ${n.odometer??"-"} • Hours: ${n.engine_hours??"-"}</div>
      </div>
      <div class="row wrap" style="gap:8px;">
        <button class="secondary btnEdit">Edit</button>
        <button class="secondary btnDelete">Delete</button>
      </div>
    `,o.querySelector(".btnEdit").onclick=()=>F(n),o.querySelector(".btnDelete").onclick=()=>R(n.id,e),s.appendChild(o)}),a("services").innerHTML="",a("services").appendChild(s)}async function P(e){const t=prompt("Reminder name (Insurance, DOT, Annual, Oil Change):","Insurance");if(!t)return;const i=(prompt("Type: date / miles / hours","date")||"").toLowerCase();if(!["date","miles","hours"].includes(i))return alert("Type must be date/miles/hours");let s={vehicle_id:e,name:t,reminder_type:i,notify_emails:g,warn_days:y,is_active:!0};if(i==="date"&&(s.due_date=prompt("Due date (YYYY-MM-DD):",w()),!s.due_date))return;if(i==="miles"&&(s.due_odometer=p(prompt("Due miles:"),NaN),!Number.isFinite(s.due_odometer)))return alert("Due miles must be a number.");if(i==="hours"&&(s.due_engine_hours=p(prompt("Due hours:"),NaN),!Number.isFinite(s.due_engine_hours)))return alert("Due hours must be a number.");const{error:n}=await d.from("reminders").insert(s);if(n)return alert(n.message);await b(e)}async function N(e,t){const i=prompt(`${t} due date (YYYY-MM-DD):`,w());if(!i)return;const s={vehicle_id:e,name:t,reminder_type:"date",due_date:i,warn_days:y,notify_emails:g,is_active:!0},{error:n}=await d.from("reminders").insert(s);if(n)return alert(n.message);await b(e),await E()}async function W(e){const t=confirm(`Keep this reminder ACTIVE?
OK = Active
Cancel = Inactive`),i=Y(prompt("Notify emails (comma separated):",e.notify_emails||g)),s=p(prompt("Warn days (SOON window):",e.warn_days??y),y),n={is_active:t,notify_emails:i,warn_days:s};if(e.reminder_type==="date"){const r=prompt("Due date (YYYY-MM-DD):",e.due_date||w());if(!r)return;n.due_date=r}if(e.reminder_type==="miles"){const r=prompt("Due miles:",e.due_odometer??"");n.due_odometer=r===""?null:p(r,null)}if(e.reminder_type==="hours"){const r=prompt("Due hours:",e.due_engine_hours??"");n.due_engine_hours=r===""?null:p(r,null)}const{error:o}=await d.from("reminders").update(n).eq("id",e.id);if(o)return alert(o.message);await b(e.vehicle_id),await E()}async function B(e,t){if(!confirm("Delete this reminder?"))return;const{error:i}=await d.from("reminders").delete().eq("id",e);if(i)return alert(i.message);await b(t),await E()}async function b(e){const{data:t,error:i}=await d.from("vehicles").select("*").eq("id",e).single();if(i){a("reminders").innerHTML=`<div class="muted">${i.message}</div>`;return}const{data:s,error:n}=await d.from("reminders").select("*").eq("vehicle_id",e).order("created_at",{ascending:!1});if(n){a("reminders").innerHTML=`<div class="muted">${n.message}</div>`;return}const o=document.createElement("div");o.className="list",(s||[]).forEach(r=>{let l="OK",_="";if(!r.is_active)l="INACTIVE";else if(r.reminder_type==="date"&&r.due_date){const u=T(r.due_date),h=Number.isFinite(r.warn_days)?r.warn_days:y;_=`Due: ${S(r.due_date)} (${u} day(s)) • Warn: ${h} days`,u<=0?l="DUE":u<=h&&(l="SOON")}else if(r.reminder_type==="miles"&&r.due_odometer!=null){const u=r.due_odometer-(t.current_odometer??0);_=`Due at: ${r.due_odometer} (left: ${u})`,u<=0?l="DUE":u<=(r.warn_miles??500)&&(l="SOON")}else if(r.reminder_type==="hours"&&r.due_engine_hours!=null){const u=r.due_engine_hours-(t.current_engine_hours??0);_=`Due at: ${r.due_engine_hours} hrs (left: ${u})`,u<=0?l="DUE":u<=(r.warn_hours??25)&&(l="SOON")}const c=r.notify_emails||g,m=document.createElement("div");m.className="item",m.innerHTML=`
      <div>
        <div><b>${r.name}</b> — ${l}</div>
        <div class="muted">${r.reminder_type.toUpperCase()} • ${_}</div>
        <div class="muted">Emails: ${c}</div>
      </div>
      <div class="row wrap" style="gap:8px;">
        <button class="secondary btnEdit">Edit</button>
        <button class="secondary btnDelete">Delete</button>
      </div>
    `,m.querySelector(".btnEdit").onclick=()=>W(r),m.querySelector(".btnDelete").onclick=()=>B(r.id,e),o.appendChild(m)}),a("reminders").innerHTML="",a("reminders").appendChild(o)}async function D(e){if(!await M())return;v=e;const{data:t,error:i}=await d.from("vehicles").select("*").eq("id",e).single();if(i)return alert(i.message);a("selectedVehicle").innerHTML=`
    <div><b>${t.name}</b> <span class="badge">${t.type}</span></div>
    <div class="muted">Current Miles: ${t.current_odometer??0} • Engine Hours: ${t.current_engine_hours??0}</div>
  `,a("vehicleDetails").style.display="block",a("btnUpdateMiles").onclick=async()=>{const s=prompt("Enter current miles (odometer):",String(t.current_odometer??0));if(s===null)return;const n=prompt("Enter current engine hours (optional):",String(t.current_engine_hours??0));if(n===null)return;const o=p(s,t.current_odometer??0),r=p(n,t.current_engine_hours??0),{error:l}=await d.from("vehicles").update({current_odometer:o,current_engine_hours:r}).eq("id",e);if(l)return alert(l.message);await f(),await D(e)},a("btnEditVehicle").onclick=async()=>{const s=prompt("Vehicle name:",t.name||"");if(!s)return;const n=prompt("Vehicle type:",t.type||"");if(!n)return;const{error:o}=await d.from("vehicles").update({name:s.trim(),type:n.trim()}).eq("id",e);if(o)return alert(o.message);await f(),await D(e)},a("btnAddService").onclick=async()=>V(e,t),a("btnAddReminder").onclick=async()=>P(e),a("btnAddDot").onclick=async()=>N(e,"DOT Inspection"),a("btnAddAnnual").onclick=async()=>N(e,"Annual Inspection"),a("btnDeleteVehicle").onclick=async()=>{if(!confirm(`Delete vehicle "${t.name}"? This will also delete its services and reminders.`))return;const{error:n}=await d.from("vehicles").delete().eq("id",e);if(n)return alert(n.message);v=null,a("selectedVehicle").textContent="Select a vehicle to view details.",a("vehicleDetails").style.display="none",await f()},await $(e),await b(e)}async function f(){const e=await M();await E(),e&&(await U(),v&&await D(v))}window.addEventListener("DOMContentLoaded",async()=>{a("btnSignUp").onclick=C,a("btnSignIn").onclick=q,a("btnLogout").onclick=H,d.auth.onAuthStateChange(async()=>{await f()}),a("vehicleForm").addEventListener("submit",async e=>{if(e.preventDefault(),!await M())return alert("Please login first.");const t=e.target,i={name:t.name.value.trim(),type:t.type.value.trim(),current_odometer:p(t.current_odometer.value||0,0),current_engine_hours:p(t.current_engine_hours.value||0,0)},{error:s}=await d.from("vehicles").insert(i);if(s)return alert(s.message);t.reset(),await f()}),await f()});
